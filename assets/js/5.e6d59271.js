(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{326:function(t,s,a){t.exports=a.p+"assets/img/status1.e542ea6a.jpeg"},358:function(t,s,a){t.exports=a.p+"assets/img/structure.a19c1d3a.jpeg"},359:function(t,s,a){t.exports=a.p+"assets/img/small_buffer.13ef287a.jpeg"},404:function(t,s,a){"use strict";a.r(s);var n=a(42),r=Object(n.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"buffer结构"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#buffer结构"}},[t._v("#")]),t._v(" Buffer结构")]),t._v(" "),n("p",[t._v("主要用于操作字节\njavascript和C++ 结合的模块，javascript负责非性能相关的部分，C++负责性能相关的部分\n"),n("img",{attrs:{src:a(358),alt:"avatar"}})]),t._v(" "),n("ul",[n("li",[t._v("用法\n直接使用，无须require(), node在进程启动时就已经加载了Buffer，并将其放到全局对象上")])]),t._v(" "),n("h2",{attrs:{id:"buffer对象"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#buffer对象"}},[t._v("#")]),t._v(" Buffer对象")]),t._v(" "),n("p",[t._v("类数组对象，元素为16进制的两位数-> 0-256的数值\n初始化对象后，它的元素值时0-256的一个随机值，我们也可以像数值赋值一样给它赋值")]),t._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),n("p",[t._v("给元素的赋值如果小于0，就将该值逐次加256，直到得到一个0到255之间的整数。如果得到的数值大于255，就逐次减256，直到得到0~255区间内的数值。如果是小数，舍弃小数部分，只保留整数部分。")])]),t._v(" "),n("div",{staticClass:"language-javascript extra-class"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[t._v("  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" buf "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Buffer")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  buf"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("19")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("buf"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("19")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 100")]),t._v("\n  buf"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("20")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("buf"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("20")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 156")]),t._v("\n  buf"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("21")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("300")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("buf"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("21")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 44")]),t._v("\n  buf"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("22")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.1415")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("buf"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("22")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 3")]),t._v("\n")])])]),n("h2",{attrs:{id:"buffer内存分配"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#buffer内存分配"}},[t._v("#")]),t._v(" Buffer内存分配")]),t._v(" "),n("p",[t._v("Node在内存的使用上应用的是在C++层面申请内存、在JavaScript中分配内存的策略。\n为了高效的使用申请来的内存，Node采用slab分配机制\nslab分配机制(一块申请好的固定大小的内存区域)\n8kb为界限区分Buffer是大对象还是小对象，8kb就是每个slab的大小值(在javascript以此作为单位单元进行内存的分配)")]),t._v(" "),n("p",[t._v("slab三种状态")]),t._v(" "),n("ul",[n("li",[t._v("full 完全分配状态")]),t._v(" "),n("li",[t._v("partial 部分分配状态")]),t._v(" "),n("li",[t._v("empty 没有被分配的状态")])]),t._v(" "),n("h3",{attrs:{id:"分配buffer小对象"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#分配buffer小对象"}},[t._v("#")]),t._v(" 分配Buffer小对象")]),t._v(" "),n("blockquote",[n("p",[t._v("大小< 8KB -> 小对象方式进行分配\n使用一个局部变量pool作为中间处理对象，处于分配状态的slab单元都指向它(pool.used表示slab已经分配的内存)")])]),t._v(" "),n("ul",[n("li",[t._v("分配一个新的slab单元")])]),t._v(" "),n("div",{staticClass:"language-javascript extra-class"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[t._v("  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" pool"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("allocPool")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    pool "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SlowBuffer")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Buffer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("poolSize"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    pool"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("used "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("ul",[n("li",[t._v("新构造的slab单元,empty状态\n"),n("img",{attrs:{src:a(359),alt:"avatar"}})])]),t._v(" "),n("p",[t._v("构造时检查是否有pool对象，如果没有就创建，然后创建一个新的slab指向它，同时Buffer的parent属性指向slab，并记录起始使用位置(offset)。"),n("br"),t._v("\n再次创建一个Buffer对象时，会先判断slab的剩余空间是否足够，如果足够就是用剩余空间，并更新使用状态，如果不够就分配新的slab单元")]),t._v(" "),n("ul",[n("li",[t._v("初次分配Buffer\n"),n("img",{attrs:{src:a(326),alt:"avatar"}})]),t._v(" "),n("li",[t._v("再次分配Buffer\n"),n("img",{attrs:{src:a(326),alt:"avatar"}})])]),t._v(" "),n("blockquote",[n("p",[t._v("slab回收只有再该单元所有Buffer释放后才能被回收")])]),t._v(" "),n("h3",{attrs:{id:"分配buffer大对象"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#分配buffer大对象"}},[t._v("#")]),t._v(" 分配Buffer大对象")]),t._v(" "),n("p",[t._v("直接分配一个SlowBuffer对象作为slab单元，SlowBuffer对象是在C++层面定义的，可用Buffer模块访问到")]),t._v(" "),n("blockquote",[n("p",[t._v("Buffer对象可被V8的垃圾回收标记回收，但内部的parent指向SlowBuffer来自C++层，所用内存不在V8堆中")])]),t._v(" "),n("h2",{attrs:{id:"小结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#小结"}},[t._v("#")]),t._v(" 小结")]),t._v(" "),n("p",[t._v("真正的内存在Node的C++层面，Javascript只是使用它。当进行小而频繁的Buffer操作时，采用slab的机制进行预先申请和事后分配，使得JavaScript到操作系统之间不必有过多的内存申请方面的系统调用。对于大块的Buffer而言，则直接使用C++层面提供的内存，而无需细腻的分配操")])])}),[],!1,null,null,null);s.default=r.exports}}]);